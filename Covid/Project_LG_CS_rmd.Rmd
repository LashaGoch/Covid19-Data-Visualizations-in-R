---
title: "Visualizations in R"
author: 'Lasha Gochiashvili & Catherine Sunil'
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: kate
    
---


```{r setup, echo=FALSE, cache=FALSE}
library(knitr)
library(rmdformats)
## Global options
options(max.print="75")
opts_chunk$set(echo=FALSE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
knitr::opts_chunk$set(echo = TRUE)
```


Libraries

```{r echo=FALSE, warning = FALSE, comment=FALSE}
library(readr)
library(dplyr)
library(tidyverse)
library(gganimate)
library(gifski)
library(png)
library(gapminder)
library(DT)
```

Unnecessary staff







```{r warning = FALSE, echo=FALSE, comment=FALSE}
data <- read_csv("https://covid.ourworldindata.org/data/owid-covid-data.csv")
  
  
#data2 <- read_csv("https://www.imf.org/external/np/fin/data/rms_mth.aspx?SelectDate=2020-10-31&reportType=SDRCV&tsvflag=Y")

#setwd("C:/Users/Lasha/Desktop/Lasha/Education/`UW DS/III Semester/Adv Viz R/Project")

```



load data

```{r}
#data <- read.csv("owid-covid-data.csv", stringsAsFactors = F)
data$date <- as.Date(data$date, "%Y-%m-%d")
datatable(head(data), caption = 'Table 1: This is a simple caption for the table.', class = 'cell-border stripe')
```


```{r}
temp <- data.frame(data) %>% select(continent, location, gdp_per_capita,
                                    population_density, total_cases, 
                                    total_cases_per_million, population)
temp <- subset(temp, location!="World" & location!="International")
data_agg <- aggregate(temp, list(temp$location, temp$continent, 
                                 temp$gdp_per_capita, temp$population_density), max)

data_agg$Group.1 <- NULL
data_agg$Group.2 <- NULL
data_agg$Group.3 <- NULL
data_agg$Group.4 <- NULL

head(data_agg)
data_agg[data_agg$location == "Zimbabwe",]
```




```{r}

data_agg$total_cases_per_million_group <- cut(data_agg$total_cases_per_million, breaks=c(0,5000,50000,100000), include.lowest = FALSE, dig.lab = 6)

data_for_dist <- data_agg %>%
  count(continent, total_cases_per_million_group)

data_for_dist <-  na.omit(data_for_dist)
head(data_for_dist)
ggplot(data_for_dist, aes(x = continent, y = total_cases_per_million_group)) + 
  geom_tile(aes(fill = n), color = 'white', show.legend = F) +
  theme_minimal() + 
  geom_text(aes(label = n), size = 5, fontface = 'bold', color = 'white') +
  labs(title = 'Countries with total cases per mln.') +
  scale_fill_gradient(low = '#6bb0c4', high = '#dd5f64') +
  theme(panel.grid = element_blank())


```

```{r}
data_sel <- data.frame(data) %>% select(continent, location, date, new_cases, 
                                        new_deaths, total_cases, total_deaths,
                                        total_cases_per_million, population)

head(data_sel)
```


```{r}
library(lubridate)
library(dplyr)

EU <- c("Austria", "Belgium", "Bulgaria", "Croatia", "Cyprus",
        "Czech Republic", "Denmark", "Estonia", "Finland", "France",
        "Germany", "Greece", "Hungary", "Ireland", "Italy", "Latvia",
        "Lithuania", "Luxembourg", "Malta", "Netherlands", "Poland",
        "Portugal", "Romania", "Slovakia", "Slovenia", "Spain", "Sweden")


data_for_month <- data.frame(data) %>% select(location, date, new_cases) %>% 
  filter(location %in% EU)

data_for_month$month <- floor_date(data_for_month$date, "month")

data_for_month <- as.tibble(data_for_month) %>%
  group_by(location, month) %>%
  summarize(new_cases = as.numeric(sum(new_cases))) 
  #mutate(new_cases = scale(new_cases))
data_for_month$month<-as.character(data_for_month$month)

ggplot(data_for_month, aes(month, location)) + 
  geom_tile(aes(fill = new_cases), colour = "white") + 
  scale_x_discrete("", expand = c(0, 0)) + 
  scale_y_discrete("", expand = c(0, 0)) + 
  #scale_fill_gradient(low="orange", high = "red")+
  #scale_fill_distiller(palette = "RdPu")+
  #theme_grey(base_size = 9) + 
  scale_fill_gradient2(low = "#006400", mid = "#f2f6c3", high = "#cd0000", 
                       midpoint = 0.5)+
  theme(legend.position = "bottom",
        axis.ticks = element_blank(), 
        axis.text.x = element_text(angle = 90, hjust = 0.5))

#ggplotly(c, tooltip="text")

```





```{r warning = FALSE, message = FALSE}
library(plotly)

ggplot(data_agg) + 
  geom_point(aes(x = total_cases, y = gdp_per_capita, color = continent, 
                 size = population), alpha=0.5) +
    labs(x = 'Total Cases',
       y = 'GDP per capita',
       title = "Covid total cases vs GDP per capita",
       caption = 'source: ') +
  theme(panel.background = element_rect(fill = 'white', color = 'white', size = 1.2),
        plot.background = element_rect(fill = 'white'),
        plot.title = element_text(hjust = 0.5, size =16, face='bold', 
                                  color = 'brown'),
        plot.caption = element_text(face = 'italic', color = 'brown'),
        panel.grid.major = element_line(linetype = 'dashed', size =0.1),
        panel.grid.minor = element_blank()) +
  scale_x_continuous(trans = "log2")+
  scale_y_continuous(trans = "log2") + 
  scale_size(range = c(.1, 24), name="Population (M)")

#ggplotly(a)
```



```{r warning = FALSE}

ggplot(data=data_agg, aes(x= total_cases, y = continent, fill=continent)) +
  geom_bar(width = 0.5, stat = 'identity') +
  labs(title = 'Total cases by continent.',
       subtitle = 'subtitle') + 
  xlab('Total Cases') +
  ylab('Continents') +
  theme(legend.position = "none",
        text = element_text(size=8),
        axis.text.y = element_text(hjust=1)) +
  geom_text(aes(label = total_cases), vjust =0.5, hjust=-0.03, 
            color = 'darkgreen', size = 3.5) +# since the bars are horizontal I put
  # the labels next to the bars
  theme(plot.title = element_text(size =12, face='bold', 
                                  color = 'brown'))

```


```{r}
library(ggiraph)
# Basic plot: 
g <- ggplot(data_agg, 
            aes(x = gdp_per_capita, y = total_cases_per_million, color =population_density))

# Interactiveness:
g_int <- g + geom_point_interactive(aes(tooltip = location), size = 2)

# WyÅ›wietlenie
ggiraph(code = print(g_int))



```



```{r warning=FALSE}
ggplot(data_agg, aes(x = gdp_per_capita, fill = continent)) + 
  geom_histogram(data = data_agg[,-5], fill = "grey", alpha = .5, bins = 30) + 
  geom_histogram(colour = "black", bins = 30) +
  facet_wrap(~ continent) + guides(fill = FALSE) 

#ggplotly(b)
```

```{r eval=FALSE}
# library(gganimate)
# library(gapminder)
# start_pause <- 0
# end_pause <- 0
# 
# ggplot(gapminder, aes(gdpPercap, lifeExp, size = pop, colour = country)) +
#   geom_point(alpha = 0.7, show.legend = FALSE) +
#   scale_colour_manual(values = country_colors) +
#   scale_size(range = c(2, 12)) +
#   scale_x_log10() +
#   facet_wrap(~continent) +
#   # Here comes the gganimate specific bits
#   labs(title = 'Year: {frame_time}', x = 'GDP per capita', y = 'life expectancy') +
#   transition_time(year) +
#   ease_aes('linear')

```


```{r}
head(data_sel)
```

```{r}
data_anim <- data_sel %>% filter(location %in% c("Germany","Canada"))
head(data_anim)
```


```{r message = FALSE, warning = FALSE, results = FALSE}
#data_anim <- data_sel %>% filter(location %in% c("Germany","Canada", "Mexico", 
#                                                 "Italy", "Spain", "Poland"))

data_anim <- data_sel %>%
  filter(continent %in% c("africa", "Asia", "Europe", "North America",
                          "South America", "Oceania"))
data_anim <- data_anim[complete.cases(data_anim),]
gifplot <- ggplot(data_anim, aes(total_cases, total_deaths,
                     size = population, colour = continent)) +
  geom_point(alpha = 0.7, show.legend = FALSE) +
  scale_size(range = c(2, 12)) +
  scale_x_log10() +
  facet_wrap(~continent) +
  # Here comes the gganimate specific bits
  labs(title = 'Year: {frame_time}', x = 'Total Cases', y = 'Total Deaths') +
  transition_time(date) +
  ease_aes('linear')

animate(gifplot, duration = 5, fps = 20, renderer = gifski_renderer())
anim_save("gifplot.gif")

```

![](gifplot.gif)



for maps:

```{r warning = FALSE}
library(tidyverse)
library(rnaturalearth)
library(cowplot)
library(sf)
library(ggmap)
library(leaflet)
library("rnaturalearth")
library("rnaturalearthdata")
library("sf")
library("rgeos")

###
library(tidyverse)
library(ggplot2)
library(readr)
library(maps)
library(viridis)

```



```{r}
world <- ne_countries(scale = "medium", returnclass = "sf")
world <- data.frame(world)
world <- world %>% rename(location = name)
head(world)
head(data_agg)
#unique(world$name)
#unique(data_sel$location)

```
```{r}
# Default theme:
theme_set(theme_bw())

world <- merge(x=world, y=data_agg, by="location", all.x = TRUE)
head(world)

```

```{r}
# ggplot(data = world) +
#   geom_sf(aes(fill = income_grp )) +
#   coord_sf(expand = FALSE) +
#   # geom_sf(aes(fill =  pop_est)) +
#   scale_fill_brewer(palette = 'YlOrBr') +
#   # scale_fill_viridis_c(option = "plasma", trans = "sqrt", guide = guide_colorbar(barwidth = 30), name = NULL) +
#   theme(legend.position = 'right') 
#   # theme(legend.position = 'bottom')


```

```{r}

datacov <- read_csv("time_series_covid19_confirmed_global.csv")

head(datacov)
```



```{r warninig = FALSE}

world <- map_data("world")

# cutoffs based on the number of cases
mybreaks <- c(1, 20, 100, 1000, 50000)

ggplot() +
 geom_polygon(data = world, aes(x=long, y = lat, group = group), fill="grey", alpha=0.3) +
 geom_point(data=datacov, aes(x=Long, y=Lat, size=`3/3/20`, color=`3/3/20`),stroke=F, alpha=0.7) +
 scale_size_continuous(name="Cases", trans="log", range=c(1,7),breaks=mybreaks, labels = c("1-19", "20-99", "100-999", "1,000-49,999", "50,000+")) +
    # scale_alpha_continuous(name="Cases", trans="log", range=c(0.1, 0.9),breaks=mybreaks) +
    scale_color_viridis_c(option="inferno",name="Cases", trans="log",breaks=mybreaks, labels = c("1-19", "20-99", "100-999", "1,000-49,999", "50,000+")) +
    theme_void() + 
    guides( colour = guide_legend()) +
    labs(caption = "Data Repository provided by Johns Hopkins CSSE. Visualization by DataScience+ ") +
    theme(
      legend.position = "bottom",
      text = element_text(color = "#22211d"),
      plot.background = element_rect(fill = "#ffffff", color = NA), 
      panel.background = element_rect(fill = "#ffffff", color = NA), 
      legend.background = element_rect(fill = "#ffffff", color = NA)
    )

```




```{r}
#remotes::install_github("GuangchuangYu/nCov2019")
#source: https://github.com/GuangchuangYu/shadowtext/blob/master/R/geom-shadowtext.R
# source: https://github.com/GuangchuangYu/nCov2019

library('remotes')
#remotes::install_github("GuangchuangYu/nCov2019", dependencies = TRUE)
library('nCov2019')

library(ggplot2)
y <- load_nCov2019(lang = 'en')
d <- y['global']
max_time <- max(d$time)
min_time <- max_time - 7
d <- na.omit(d[d$time >= min_time & d$time <= max_time,])
dd <- d[d$time == max(d$time, na.rm = TRUE),]
d$country <- factor(d$country, 
  levels=unique(dd$country[order(dd$cum_confirm)]))
breaks = c(10, 100, 1000, 10000)
ggplot(d, aes(time, country)) + 
  geom_tile(aes(fill = cum_confirm), color = 'black') + 
  scale_fill_viridis_c(trans = 'log', breaks = breaks, 
  labels = breaks) + 
  xlab(NULL) + ylab(NULL) +
  scale_x_date(date_labels = "%Y-%m-%d") + theme_minimal()

```

```{r}

# require(nCov2019)
# y <- load_nCov2019(lang = 'en', source='github')
# d = y['global']
# 
# 
# require(dplyr)
# dd <- filter(d, time == time(y)) %>% 
#     arrange(desc(cum_confirm)) 
# 
# dd = dd[1:40, ]
# dd$country = factor(dd$country, levels=dd$country)
# 
# dd$angle = 1:40 * 360/40
# require(ggplot2)
# p <- ggplot(dd, aes(country, cum_confirm, fill=cum_confirm)) + 
#     geom_col(width=1, color='grey90') + 
#     geom_col(aes(y=I(5)), width=1, fill='grey90', alpha = .2) +       
#     geom_col(aes(y=I(3)), width=1, fill='grey90', alpha = .2) +    
#     geom_col(aes(y=I(2)), width=1, fill = "white") +
#     scale_y_log10() + 
#     scale_fill_gradientn(colors=c("darkgreen", "green", "orange", "firebrick","red"), trans="log") + 
#     geom_text(aes(label=paste(country, cum_confirm, sep="\n"), 
#                   y = cum_confirm *.8, angle=angle), 
#             data=function(d) d[d$cum_confirm > 700,], 
#             size=3, color = "white", fontface="bold", vjust=1)  + 
#      geom_text(aes(label=paste0(cum_confirm, " cases ", country), 
#                   y = max(cum_confirm) * 2, angle=angle+90), 
#             data=function(d) d[d$cum_confirm < 700,], 
#             size=3, vjust=0) + 
#     coord_polar(direction=-1) + 
#     theme_void() + 
#     theme(legend.position="none") +
#     ggtitle("COVID19 global trend", time(y))
# 
# print(p)
```

```{r}

# library('maps')
# x = world
# plot(x)

```


```{r cars, echo=FALSE, eval = FALSE}


#OECD <- c("Austria", "Australia", "Belgium", "Canada", "Chile", "Colombia", 
#          "Czech Republic", "Denmark", "Estonia", "Finland", "France", "Germany", 
#          "Greece", "Hungary", "Iceland", "Ireland", "Israel", "Italy", "Japan", "Korea", 
#          "Latvia", "Lithuania", "Luxembourg", "Mexico", "Netherlands", "New Zealand", 
#          "Norway", "Poland", "Portugal", "Slovakia", "Slovenia", "Spain", 
#          "Sweden", "Switzerland", "Turkey", "United Kingdom", "United States")

#head(OECD)
#data$OECD <- ifelse(data$location %in% OECD, 1, 0)

#data <- data.frame(data)

# table(data$OECD)
# 
# glimpse(data)
# summary(data)
# 
# hist(data$OECD)
# 
# EU <- c("Austria", "Belgium", "Bulgaria", "Croatia", "Cyprus", 
#         "Czech Republic", "Denmark", "Estonia", "Finland", "France", 
#         "Germany", "Greece", "Hungary", "Ireland", "Italy", "Latvia", 
#         "Lithuania", "Luxembourg", "Malta", "Netherlands", "Poland", 
#         "Portugal", "Romania", "Slovakia", "Slovenia", "Spain", "Sweden")
# 
# data$EU <- ifelse(data$location %in% EU, 1, 0)
# head(data$EU)
# 
# hist(data$EU)
# 
# 
# 
# p2 <- ggplot(movies, aes(x = rank, # Sort by rank on the horizontal axis
#                          y = p10*votes/1000, # On the vertical axis we put the total number of "10"s
#                          color = (year>2000))) + # mark XXI century with different color
#   labs(x = "IMDB Rank",
#        y = "Total number of '10's",
#        title = "IMDB Rank vs Total Number of '10's",
#        caption = 'source: www.imdb.com') +
#   theme(panel.background = element_rect(fill = 'grey', color = 'white', size = 1.2),
#         plot.background = element_rect(fill = 'grey'),
#         plot.title = element_text(hjust = 0.5, size =16, face='bold', 
#                                   color = 'brown'),
#         plot.caption = element_text(face = 'italic', color = 'brown'),
#         panel.grid.major = element_line(linetype = 'dashed', size =0.1),
#         panel.grid.minor = element_blank()) +
#   
#   geom_point() 
# 
# p2
# 
# 
# p3 + guides(color =  guide_legend(title = "Okres",
#                                   title.position = "left",
#                                   title.hjust = 0.5,
#                                   title.theme = element_text(size = 15, # font size
#                                                              face = "bold", # font sub-type (bold)
#                                                              colour = "blue", # font color
#                                                              angle = 90 ))) # rotate font box
# 
# p4 + guides(alpha=guide_legend(title = "Median Prices $K",
#                                title.position = "right",
#                                title.hjust = 0.5,
#                                title.theme = element_text(size = 10, # font size
#                                                           face = "bold", # font sub-type (bold)
#                                                           colour = "brown", # font color
#                                                           angle = 90 ),
#                                override.aes = list(shape = 15, size = 8),
#                                reverse = TRUE)) +
#   labs(title = "Mean No. of rooms vs % of lower class ppl") +
#   theme(plot.title = element_text(size =12, face='bold', 
#                                   color = 'brown'))
# 
# p1 <- p + 
#   labs(x = "Year", y = "Budget", title = "Budget vs Year of production") + 
#   geom_point() + 
#   scale_y_continuous(name = "Budged ['000 of USD]",
#                      breaks = seq(0,200000000,by = 10000000), # use function seq() - operate on original scale values
#                      labels = format(seq(0,200000,by=10000), big.mark = " "),
#                      limits = c(0, 100000000)) # put scaled labels with space as bigval separator
# p1
# 
# p1 + geom_point(aes(color = rating)) + 
#   scale_color_gradient2(low = 'red', mid = 'orange',   high="yellow", midpoint = mean(movies$rating))
# 
# p1 + theme(panel.background = element_rect(fill = 'grey', color = '#377EB8', size = 1.2),
#            plot.background = element_rect(fill = 'grey'),
#            plot.title = element_text(hjust = 0.5, size =16, face='bold', 
#                                      color = 'red'),
#            panel.grid.major = element_line(linetype = 'dashed', size =0.1),
#            panel.grid.minor = element_blank(),
#            legend.position = 'bottom',
#            legend.background = element_rect(fill='grey', linetype = 'solid',
#                                             colour = '#377EB8', size=1))
# 
# 
# 
# ggplot(data = rs, aes(x = Age)) +
#   geom_bar(stat = 'count', fill = 'darkgreen', color = 'darkgreen',
#            aes(y = ..count..)) +
#   theme_minimal() +
#   geom_text(aes(label = ..count..), stat = 'count', vjust = -.4)
# 
# # colors: "#999999", "#E69F00", "#56B4E9"
# 
# 
# 
# 
# # Read data
# hp <- read.csv2('happy2015.csv', header = TRUE, sep = ",", dec = ".") 
# 
# glimpse(hp)
# 
# # Group the data:
# hp2 <- hp %>% 
#   group_by(Region) %>% 
#   dplyr::summarise(N = n(), Mean.happiness = round(mean(Happiness.Score),2))
# 
# hp2
# 
# # if we use this data for geom_bar it does not work:
# 
# ggplot(data=hp2, aes(x= Mean.happiness, y = Region, fill=Region)) +
#   geom_bar(width = 0.5, stat = 'identity') +
#   labs(title = 'Happiness AVG Score by Reg.',
#        subtitle = '0 - not happy; 10 - very happy') + 
#   xlab('Mean Happiness') +
#   ylab('Region') +
#   theme(legend.position = "none",
#         text = element_text(size=8),
#         axis.text.y = element_text(hjust=1)) +
#   geom_text(aes(label = Mean.happiness), vjust =0.5, hjust=-0.03, 
#             color = 'darkgreen', size = 3.5) +# since the bars are horizontal I put
#   # the labels next to the bars
#   theme(plot.title = element_text(size =12, face='bold', 
#                                   color = 'brown'))
# 
# 
# 
# rs <- read.csv2('data/responses.csv', header = TRUE, sep = ",", dec = ".") 
# glimpse(rs)
# 
# rs_2 <- rs %>% 
#   dplyr::group_by(Fear.of.public.speaking, Gender) %>% 
#   dplyr::summarise(number = length(Fear.of.public.speaking))
# 
# 
# 
# ggplot(data=rs_2, aes(x= factor(Fear.of.public.speaking),
#                       y=number, fill=factor(Gender))) +
#   geom_bar(width = 0.5, stat = 'identity', position="stack") +
#   labs(title = 'People with Fear of Public Speaking',
#        caption = '1 - not afraid; 5 - much afraid',
#        x = 'Fear of Public Speaking',
#        y = 'Number of people',
#        fill = 'Gender') +
#   scale_fill_manual(values = c('deepskyblue3', 'dodgerblue4')) +
#   theme(legend.position = 'left', plot.title = element_text(size =12, face='bold', 
#                                                             color = 'brown')) +
#   geom_text(aes(label = number), position = 'stack',
#             vjust =-0.5, hjust=0.5, size = 3.5) 
# 
# 
# glimpse(rs)
# 
# 
# rs_3 <- rs %>% 
#   dplyr::group_by(Education, Entertainment.spending) %>% 
#   dplyr::summarise(number = length(Education))
# 
# glimpse(rs_3)
# 
# ggplot(data=rs_3, aes(x= Education,
#                       y=number, fill=factor(Entertainment.spending))) +
#   geom_bar(width = 0.5, stat = 'identity', position="dodge") +
#   labs(title = 'Attitude to savings vs the education level',
#        Caption = '1 - low spending; 5 - high spending',
#        x = 'Education level',
#        y = 'Number of respondents') +
#   scale_fill_manual(values = c('deepskyblue3', 'khaki', "#999999", "#E69F00", "#56B4E9")) +
#   geom_text(aes(label = number), vjust = -.5, position = position_dodge(.5),
#             size = 2.5) +
#   theme(legend.position = 'left', text = element_text(size=8),
#         plot.title = element_text(size =12, face='bold', 
#                                   color = 'brown'),
#         panel.background = element_rect(fill = 'grey', color = 'white', size = 1.2),
#         plot.background = element_rect(fill = 'grey'),
#         panel.grid= element_line(linetype = 'dashed', size =0.1)) +
#   guides(fill=guide_legend(title = "Scale of Spending",
#                            title.position = "left",
#                            title.hjust = 0.5,
#                            title.theme = element_text(size = 10, # font size
#                                                       face = "bold", # font sub-type (bold)
#                                                       colour = "brown", # font color
#                                                       angle = 90 )))
# 
# 
# 


```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE, eval = FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
